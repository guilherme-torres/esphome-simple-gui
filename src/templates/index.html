<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dispositivos</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='bootstrap/css/bootstrap.min.css') }}">
    <script src="{{ url_for('static', filename='bootstrap/js/bootstrap.bundle.min.js') }}"></script>
</head>

<body>
    <div class="container mt-4">
        <h1 class="mb-4 fw-bold">Dispositivos</h1>
        {% if devices|length == 0 %}
        <div class="alert alert-info" role="alert">
            Nenhum dispositivo criado
        </div>
        {% else %}
        <div class="row">
            {% for device in devices %}
            <div class="col-md-4 mb-4">
                <div class="card h-100 shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title">{{ device.name }}</h5>
                        <div class="mt-3 d-flex justify-content-end gap-2">
                            <form action="{{ url_for('upload_config', device_id=device.id) }}" method="post">
                                <button type="button" class="btn btn-success btn-sm" data-bs-toggle="modal"
                                    data-bs-target="#confirmUploadModal{{ device.id }}">
                                    Upload
                                </button>

                                <div class="modal fade" id="confirmUploadModal{{ device.id }}" tabindex="-1"
                                    aria-labelledby="confirmUploadModalLabel{{ device.id }}" aria-hidden="true">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <form action="{{ url_for('upload_config', device_id=device.id) }}"
                                                method="post">
                                                <div class="modal-header">
                                                    <h5 class="modal-title" id="confirmUploadModalLabel{{ device.id }}">
                                                        Atenção!</h5>
                                                    <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                        aria-label="Fechar"></button>
                                                </div>
                                                <div class="modal-body">
                                                    <p class="fw-bold">Certifique-se de conectar seu dispositivo ESP no
                                                        computador através da porta USB.</p>
                                                    <div class="mb-3">
                                                        <label for="serialPortSelect{{ device.id }}"
                                                            class="form-label">Selecione a porta serial</label>
                                                        <select class="form-select" id="serialPortSelect{{ device.id }}"
                                                            name="serial_port"
                                                            onclick="fetchSerialPorts({{ device.id }})" disabled>
                                                            <option value="">Clique para buscar portas...</option>
                                                        </select>
                                                        <div id="serialPortLoading{{ device.id }}"
                                                            class="form-text text-muted" style="display:none;">
                                                            Carregando portas seriais...
                                                        </div>
                                                    </div>
                                                    <div class="form-check mb-3">
                                                        <input class="form-check-input" type="checkbox"
                                                            id="usbConfirm{{ device.id }}"
                                                            onchange="document.getElementById('confirmUploadBtn{{ device.id }}').disabled = !this.checked;">
                                                        <label class="form-check-label" for="usbConfirm{{ device.id }}">
                                                            Meu dispositivo ESP já está conectado.
                                                        </label>
                                                    </div>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-secondary"
                                                        data-bs-dismiss="modal">Cancelar</button>
                                                    <button type="submit" class="btn btn-success"
                                                        id="confirmUploadBtn{{ device.id }}" disabled>Confirmar
                                                        upload</button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </form>
                            <a href="{{ url_for('edit_device', device_id=device.id) }}"
                                class="btn btn-primary btn-sm">Editar</a>
                            <form action="{{ url_for('delete_device', device_id=device.id) }}" method="post">
                                <button type="button" class="btn btn-danger btn-sm" data-bs-toggle="modal"
                                    data-bs-target="#deleteModal{{ device.id }}">
                                    Excluir
                                </button>

                                <div class="modal fade" id="deleteModal{{ device.id }}" tabindex="-1"
                                    aria-labelledby="deleteModalLabel{{ device.id }}" aria-hidden="true">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="deleteModalLabel{{ device.id }}">Confirmar
                                                    Exclusão</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                    aria-label="Fechar"></button>
                                            </div>
                                            <div class="modal-body">
                                                Tem certeza que deseja excluir este dispositivo?
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary"
                                                    data-bs-dismiss="modal">Cancelar</button>
                                                <button type="submit" class="btn btn-danger">Excluir</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </div>

    <button type="button" class="btn btn-success btn-lg rounded-pill fs-5"
        style="position: fixed; bottom: 32px; right: 32px; z-index: 1050;" data-bs-toggle="modal"
        data-bs-target="#newDeviceModal">
        + Novo dispositivo
    </button>

    <div class="modal fade" id="newDeviceModal" tabindex="-1" aria-labelledby="newDeviceModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form action="{{ url_for('create_device') }}" method="post">
                    <div class="modal-header">
                        <h5 class="modal-title" id="newDeviceModalLabel">Novo Dispositivo</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="deviceName" class="form-label">Nome do dispositivo</label>
                            <input type="text" class="form-control" id="deviceName" name="deviceName" required>
                        </div>
                        <div class="mb-3">
                            <label for="platform" class="form-label">Plataforma</label>
                            <select class="form-select" id="platform" name="platform" required>
                                <option selected value="esp8266">ESP8266</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="board" class="form-label">Placa</label>
                            <select class="form-select" id="board" name="board" required>
                                <option value="agruminolemon">Lifely Agrumino Lemon v4</option>
                                <option value="d1_mini_lite">WeMos D1 mini Lite</option>
                                <option value="d1_mini">WeMos D1 R2 and mini</option>
                                <option value="d1_mini_pro">WeMos D1 mini Pro</option>
                                <option value="d1">WEMOS D1 R1</option>
                                <option value="eduinowifi">Schirmilabs Eduino WiFi</option>
                                <option value="esp01_1m">Espressif Generic ESP8266 ESP-01 1M</option>
                                <option value="esp01">Espressif Generic ESP8266 ESP-01 512k</option>
                                <option value="esp07">Espressif Generic ESP8266 ESP-07 1MB</option>
                                <option value="esp07s">Espressif Generic ESP8266 ESP-07S</option>
                                <option value="esp12e">Espressif ESP8266 ESP-12E</option>
                                <option value="esp210">SweetPea ESP-210</option>
                                <option value="esp8285">Generic ESP8285 Module</option>
                                <option value="espduino">ESPDuino (ESP-13 Module)</option>
                                <option value="espectro">ESPectro Core</option>
                                <option value="espino">ESPino</option>
                                <option value="espinotee">ThaiEasyElec ESPino</option>
                                <option value="espmxdevkit">ESP-Mx DevKit (ESP8285)</option>
                                <option value="espresso_lite_v1">ESPresso Lite 1.0</option>
                                <option value="espresso_lite_v2">ESPresso Lite 2.0</option>
                                <option value="esp_wroom_02">ESP-WROOM-02</option>
                                <option value="gen4iod">4D Systems gen4 IoD Range</option>
                                <option value="heltec_wifi_kit_8">Heltec Wifi kit 8</option>
                                <option value="huzzah">Adafruit HUZZAH ESP8266</option>
                                <option value="inventone">Invent One</option>
                                <option value="modwifi">Olimex MOD-WIFI-ESP8266(-DEV)</option>
                                <option value="nodemcu">NodeMCU 0.9 (ESP-12 Module)</option>
                                <option value="nodemcuv2" selected>NodeMCU 1.0 (ESP-12E Module)</option>
                                <option value="oak">DigiStump Oak</option>
                                <option value="phoenix_v1">Phoenix 1.0</option>
                                <option value="phoenix_v2">Phoenix 2.0</option>
                                <option value="sonoff_basic">Sonoff Basic</option>
                                <option value="sonoff_s20">Sonoff S20</option>
                                <option value="sonoff_sv">Sonoff SV</option>
                                <option value="sonoff_th">Sonoff TH</option>
                                <option value="sparkfunBlynk">SparkFun Blynk Board</option>
                                <option value="thingdev">SparkFun ESP8266 Thing Dev</option>
                                <option value="thing">SparkFun ESP8266 Thing</option>
                                <option value="wifiduino">WiFiduino</option>
                                <option value="wifinfo">WifInfo</option>
                                <option value="wifi_slot">WiFi Slot</option>
                                <option value="wio_link">Wio Link</option>
                                <option value="wio_node">Wio Node</option>
                                <option value="xinabox_cw01">XinaBox CW01</option>
                            </select>
                        </div>
                        <hr>
                        <h5 class="mb-3">Rede Wi-Fi</h5>
                        <div class="mb-3">
                            <label for="wifiSsid" class="form-label">Nome da rede</label>
                            <input type="text" class="form-control" id="wifiSsid" name="wifiSsid" required>
                        </div>
                        <div class="mb-3">
                            <label for="wifiPassword" class="form-label">Senha</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="wifiPassword" name="wifiPassword"
                                    required>
                                <button class="btn btn-outline-secondary" type="button" id="toggleWifiPassword"
                                    tabindex="-1" onclick="toggleWifiPasswordVisibility()">
                                    <img id="wifiPasswordIcon" src="{{ url_for('static', filename='icons/eye.svg') }}"
                                        alt="mostrar senha">
                                </button>
                            </div>
                        </div>
                        <!-- <hr>
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="otaProtected"
                                onchange="toggleOtaPassword()">
                            <label class="form-check-label" for="otaProtected">Proteger atualizações OTA com
                                senha</label>
                        </div>
                        <div class="mb-3" id="otaPasswordGroup" style="display: none;">
                            <label for="otaPassword" class="form-label">Senha OTA</label>
                            <input type="password" class="form-control" id="otaPassword" name="otaPassword">
                        </div> -->
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-success">Criar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        /*function toggleOtaPassword() {
            const group = document.getElementById('otaPasswordGroup');
            const checkbox = document.getElementById('otaProtected');
            group.style.display = checkbox.checked ? 'block' : 'none';
        }*/

        function toggleWifiPasswordVisibility() {
            const input = document.getElementById('wifiPassword');
            const btn = document.getElementById('toggleWifiPassword');
            const wifiPasswordIcon = document.getElementById('wifiPasswordIcon')

            if (input.type === 'password') {
                input.type = 'text';
                wifiPasswordIcon.src = "{{ url_for('static', filename='icons/eye-slash.svg') }}"
                wifiPasswordIcon.alt = "ocultar senha"
            } else {
                input.type = 'password';
                wifiPasswordIcon.src = "{{ url_for('static', filename='icons/eye.svg') }}"
                wifiPasswordIcon.alt = "mostrar senha"
            }
        }

        function fetchSerialPorts(deviceId) {
            const select = document.getElementById('serialPortSelect' + deviceId);
            const loading = document.getElementById('serialPortLoading' + deviceId);

            // Evita múltiplas requisições
            if (select.options.length > 1) return;

            select.disabled = true;
            loading.style.display = 'inline';

            fetch('/available-ports')
                .then(response => response.json())
                .then(data => {
                    select.innerHTML = '';
                    if (data.length === 0) {
                        select.innerHTML = '<option value="">Nenhuma porta encontrada</option>';
                    } else {
                        select.innerHTML = '<option value="">Selecione uma porta...</option>';
                        data.forEach(port => {
                            const option = document.createElement('option');
                            option.value = port;
                            option.textContent = port;
                            select.appendChild(option);
                        });
                    }
                    select.disabled = false;
                    loading.style.display = 'none';
                })
                .catch(() => {
                    select.innerHTML = '<option value="">Erro ao buscar portas</option>';
                    select.disabled = false;
                    loading.style.display = 'none';
                });
        }

        // Habilita o select quando o modal é aberto
        document.addEventListener('shown.bs.modal', function (event) {
            const modal = event.target;
            if (modal.id.startsWith('confirmUploadModal')) {
                const deviceId = modal.id.replace('confirmUploadModal', '');
                const select = document.getElementById('serialPortSelect' + deviceId);
                select.disabled = false;
                select.innerHTML = '<option value="">Clique para buscar portas...</option>';
                document.getElementById('serialPortLoading' + deviceId).style.display = 'none';
            }
        });
    </script>
</body>

</html>